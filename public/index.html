<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px; /* Increased for more product columns */
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
            margin-bottom: 15px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        /* Table container with horizontal scroll */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background: white;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            min-width: 1500px; /* Increased for more product columns */
            border-collapse: collapse;
            background: white;
        }

        .data-table th, .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
            vertical-align: top;
            font-size: 13px;
        }

        .data-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Product-specific column widths */
        .data-table.products-table th:nth-child(1), .data-table.products-table td:nth-child(1) { /* ID */
            width: 50px; min-width: 50px;
        }
        .data-table.products-table th:nth-child(2), .data-table.products-table td:nth-child(2) { /* Company */
            width: 100px; min-width: 100px;
        }
        .data-table.products-table th:nth-child(3), .data-table.products-table td:nth-child(3) { /* Shopify ID */
            width: 80px; min-width: 80px;
        }
        .data-table.products-table th:nth-child(4), .data-table.products-table td:nth-child(4) { /* Title */
            width: 200px; min-width: 200px; white-space: normal; max-width: 200px;
        }
        .data-table.products-table th:nth-child(5), .data-table.products-table td:nth-child(5) { /* Handle */
            width: 120px; min-width: 120px;
        }
        .data-table.products-table th:nth-child(6), .data-table.products-table td:nth-child(6) { /* Type */
            width: 100px; min-width: 100px;
        }
        .data-table.products-table th:nth-child(7), .data-table.products-table td:nth-child(7) { /* Vendor */
            width: 100px; min-width: 100px;
        }
        .data-table.products-table th:nth-child(8), .data-table.products-table td:nth-child(8) { /* Price */
            width: 80px; min-width: 80px; text-align: right;
        }
        .data-table.products-table th:nth-child(9), .data-table.products-table td:nth-child(9) { /* Days Old */
            width: 70px; min-width: 70px; text-align: center;
        }
        .data-table.products-table th:nth-child(10), .data-table.products-table td:nth-child(10) { /* Image */
            width: 60px; min-width: 60px; text-align: center;
        }
        .data-table.products-table th:nth-child(11), .data-table.products-table td:nth-child(11) { /* Is New */
            width: 60px; min-width: 60px; text-align: center;
        }
        .data-table.products-table th:nth-child(12), .data-table.products-table td:nth-child(12) { /* First Seen */
            width: 90px; min-width: 90px;
        }
        .data-table.products-table th:nth-child(13), .data-table.products-table td:nth-child(13) { /* Last Seen */
            width: 90px; min-width: 90px;
        }
        .data-table.products-table th:nth-child(14), .data-table.products-table td:nth-child(14) { /* Actions */
            width: 120px; min-width: 120px;
        }

        /* Company table column widths */
        .data-table.companies-table th:nth-child(1), .data-table.companies-table td:nth-child(1) { /* ID */
            width: 60px; min-width: 60px;
        }
        .data-table.companies-table th:nth-child(2), .data-table.companies-table td:nth-child(2) { /* Name */
            width: 150px; min-width: 150px;
        }
        .data-table.companies-table th:nth-child(3), .data-table.companies-table td:nth-child(3) { /* URL */
            width: 200px; min-width: 200px;
        }
        .data-table.companies-table th:nth-child(4), .data-table.companies-table td:nth-child(4) { /* Domain */
            width: 150px; min-width: 150px;
        }
        .data-table.companies-table th:nth-child(5), .data-table.companies-table td:nth-child(5) { /* Industry */
            width: 120px; min-width: 120px;
        }
        .data-table.companies-table th:nth-child(6), .data-table.companies-table td:nth-child(6) { /* Description */
            width: 200px; min-width: 200px; white-space: normal; max-width: 200px;
        }
        .data-table.companies-table th:nth-child(7), .data-table.companies-table td:nth-child(7) { /* Active */
            width: 80px; min-width: 80px; text-align: center;
        }
        .data-table.companies-table th:nth-child(8), .data-table.companies-table td:nth-child(8) { /* Created */
            width: 100px; min-width: 100px;
        }
        .data-table.companies-table th:nth-child(9), .data-table.companies-table td:nth-child(9) { /* Actions */
            width: 180px; min-width: 180px;
        }

        /* URL links styling */
        .data-table a {
            color: #007bff;
            text-decoration: none;
            font-size: 12px;
        }

        .data-table a:hover {
            text-decoration: underline;
        }

        /* Action buttons in table */
        .data-table .btn {
            padding: 6px 10px;
            font-size: 11px;
            margin: 1px;
            min-width: auto;
        }

        /* Product image thumbnail */
        .product-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            z-index: 1000;
        }

        .connected {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .disconnected {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .config-item label {
            display: flex;
            align-items: center;
            font-weight: 500;
            cursor: pointer;
        }

        .config-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .copy-paste-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .copy-paste-area:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .copy-paste-area textarea {
            width: 100%;
            height: 150px;
            border: none;
            background: transparent;
            resize: vertical;
            font-family: monospace;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .setup-banner {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .setup-banner h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-row, .form-row-three {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                min-width: 1200px;
            }
            
            .data-table th, .data-table td {
                padding: 6px 8px;
                font-size: 12px;
            }
        }

        /* Scroll indicator */
        .table-container::after {
            content: "← Scroll horizontally to see all columns →";
            display: block;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #dee2e6;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span id="statusText">Checking...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>Database Admin Panel</h1>
            <p>Manage Companies, Products & Monitoring Configurations</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('setup')">Setup</button>
            <button class="tab" onclick="showTab('companies')">Companies</button>
            <button class="tab" onclick="showTab('products')">Products</button>
            <button class="tab" onclick="showTab('monitoring')">Monitoring Config</button>
        </div>

        <div class="content">
            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="setup-banner">
                    <h3>🚀 First Time Setup</h3>
                    <p>Click the button below to initialize your database tables</p>
                </div>
                
                <div id="setupAlert"></div>
                
                <button class="btn btn-primary" onclick="setupDatabase()" id="setupBtn">
                    Initialize Database Tables
                </button>
                
                <div style="margin-top: 30px;">
                    <h3>Database Status</h3>
                    <div id="dbStatus">Click "Test Connection" to check database status</div>
                    <button class="btn btn-secondary" onclick="testConnection()" id="testBtn">
                        Test Connection
                    </button>
                </div>

                <div class="stats-grid" id="statsGrid" style="margin-top: 30px; display: none;">
                    <div class="stat-card">
                        <h3 id="companiesCount">0</h3>
                        <p>Companies</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="productsCount">0</h3>
                        <p>Products</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="newProductsCount">0</h3>
                        <p>New Products</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="monitoringConfigsCount">0</h3>
                        <p>Monitoring Configs</p>
                    </div>
                </div>
            </div>

            <!-- Companies Tab -->
            <div id="companies" class="tab-content">
                <h2>Manage Companies</h2>
                <div id="companyAlert"></div>
                
                <div class="copy-paste-area">
                    <h3>Quick Add Companies (Copy & Paste)</h3>
                    <p>Paste company data here (one per line or comma-separated):</p>
                    <textarea id="companyBulkInput" placeholder="Company A, Company B, Company C&#10;or&#10;Company A&#10;Company B&#10;Company C"></textarea>
                    <button class="btn btn-primary" onclick="bulkAddCompanies()">Add All Companies</button>
                </div>

                <h3>Add Single Company</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyName">Company Name *</label>
                        <input type="text" id="companyName" placeholder="Enter company name" required>
                    </div>
                    <div class="form-group">
                        <label for="companyUrl">Website URL</label>
                        <input type="url" id="companyUrl" placeholder="https://example.com">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyDomain">Domain</label>
                        <input type="text" id="companyDomain" placeholder="example.com">
                    </div>
                    <div class="form-group">
                        <label for="companyIndustry">Industry</label>
                        <input type="text" id="companyIndustry" placeholder="e.g., Technology, Healthcare, Finance">
                    </div>
                </div>
                <div class="form-group">
                    <label for="companyDescription">Description</label>
                    <textarea id="companyDescription" placeholder="Company description"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addCompany()">Add Company</button>
                <button class="btn btn-secondary" onclick="loadCompanies()">Refresh List</button>

                <h3>Current Companies</h3>
                <div class="table-container">
                    <table class="data-table companies-table" id="companiesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>URL</th>
                                <th>Domain</th>
                                <th>Industry</th>
                                <th>Description</th>
                                <th>Active</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="companiesTableBody">
                            <tr><td colspan="9">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <h2>Manage Products</h2>
                <div id="productAlert"></div>

                <h3>Add Product</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCompany">Company *</label>
                        <select id="productCompany" required>
                            <option value="">Select a company...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productShopifyId">Shopify Product ID</label>
                        <input type="number" id="productShopifyId" placeholder="Enter Shopify product ID">
                    </div>
                </div>
                <div class="form-group">
                    <label for="productTitle">Product Title *</label>
                    <input type="text" id="productTitle" placeholder="Enter product title" required>
                </div>
                <div class="form-row-three">
                    <div class="form-group">
                        <label for="productHandle">Handle</label>
                        <input type="text" id="productHandle" placeholder="product-handle">
                    </div>
                    <div class="form-group">
                        <label for="productType">Product Type</label>
                        <input type="text" id="productType" placeholder="e.g., T-Shirts, Electronics">
                    </div>
                    <div class="form-group">
                        <label for="productVendor">Vendor</label>
                        <input type="text" id="productVendor" placeholder="Vendor name">
                    </div>
                </div>
                <div class="form-row-three">
                    <div class="form-group">
                        <label for="productPrice">Price</label>
                        <input type="number" id="productPrice" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="productDaysOld">Days Old When Found</label>
                        <input type="number" id="productDaysOld" placeholder="Number of days">
                    </div>
                    <div class="form-group">
                        <label for="productCreatedAtShopify">Shopify Creation Date</label>
                        <input type="datetime-local" id="productCreatedAtShopify">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="productUrl">Product URL</label>
                        <input type="url" id="productUrl" placeholder="https://example.com/products/product-name">
                    </div>
                    <div class="form-group">
                        <label for="productImageUrl">Main Image URL</label>
                        <input type="url" id="productImageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                <div class="form-group">
                    <label for="productTags">Tags (comma-separated)</label>
                    <textarea id="productTags" placeholder="tag1, tag2, tag3"></textarea>
                </div>
                <div class="form-group">
                    <label for="productIsNew">
                        <input type="checkbox" id="productIsNew" checked> Is New Product
                    </label>
                </div>
                <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
                <button class="btn btn-secondary" onclick="loadProducts()">Refresh List</button>

                <h3>Current Products</h3>
                <div class="table-container">
                    <table class="data-table products-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Company</th>
                                <th>Shopify ID</th>
                                <th>Title</th>
                                <th>Handle</th>
                                <th>Type</th>
                                <th>Vendor</th>
                                <th>Price</th>
                                <th>Days Old</th>
                                <th>Image</th>
                                <th>New</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr><td colspan="14">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monitoring Config Tab -->
            <div id="monitoring" class="tab-content">
                <h2>Monitoring Configurations</h2>
                <div id="monitoringAlert"></div>

                <h3>Add/Edit Monitoring Config</h3>
                <div class="form-group">
                    <label for="monitoringCompany">Company</label>
                    <select id="monitoringCompany">
                        <option value="">Select a company...</option>
                    </select>
                </div>

                <h4>Monitoring Settings</h4>
                <div class="config-grid" id="configGrid">
                    <div class="config-item">
                        <label for="daysBack">Days Back to Monitor</label>
                        <input type="number" id="daysBack" min="1" max="365" value="7" placeholder="7">
                        <small>How many days back to check for data</small>
                    </div>
                    <div class="config-item">
                        <label for="maxProducts">Max Products to Monitor</label>
                        <input type="number" id="maxProducts" min="1" max="1000" value="50" placeholder="50">
                        <small>Maximum number of products to track</small>
                    </div>
                    <div class="config-item">
                        <label for="checkFrequency">Check Frequency</label>
                        <select id="checkFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="hourly">Hourly</option>
                        </select>
                        <small>How often to run monitoring checks</small>
                    </div>
                    <div class="config-item">
                        <label>
                            <input type="checkbox" id="isEnabled" checked> 
                            Enable Monitoring
                        </label>
                        <small>Turn monitoring on/off for this company</small>
                    </div>
                </div>

                <div class="copy-paste-area">
                    <h4>Copy Configuration Template</h4>
                    <p>Use this template to quickly configure multiple companies:</p>
                    <textarea id="configTemplate" readonly>
{
  "daysBack": 7,
  "maxProducts": 50,
  "checkFrequency": "weekly",
  "isEnabled": true
}</textarea>
                    <button class="btn btn-secondary" onclick="copyConfigTemplate()">Copy Template</button>
                    <button class="btn btn-primary" onclick="applyConfigTemplate()">Apply from Clipboard</button>
                </div>

                <button class="btn btn-primary" onclick="saveMonitoringConfig()">Save Configuration</button>
                <button class="btn btn-secondary" onclick="loadMonitoringConfigs(); clearMonitoringForm();">Refresh List</button>

                <h3>Current Monitoring Configurations</h3>
                <div class="table-container">
                    <table class="data-table" id="monitoringTable">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Days Back</th>
                                <th>Max Products</th>
                                <th>Frequency</th>
                                <th>Enabled</th>
                                <th>Last Monitored</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monitoringTableBody">
                            <tr><td colspan="7">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - change this to your deployed URL
        const API_BASE = window.location.origin;

        // Global state
        let companies = [];
        let products = [];
        let monitoringConfigs = [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            showTab('setup');
            loadStats();
        });

        // API helper functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'API call failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load data when switching to relevant tabs
            if (tabName === 'setup') {
                loadStats();
            } else if (tabName === 'companies') {
                loadCompanies();
            } else if (tabName === 'products') {
                loadProducts();
                loadCompaniesForSelect('productCompany');
            } else if (tabName === 'monitoring') {
                loadMonitoringConfigs();
                loadCompaniesForSelect('monitoringCompany');
            }
        }

        // Database setup functions
        async function setupDatabase() {
            const setupBtn = document.getElementById('setupBtn');
            setupBtn.disabled = true;
            setupBtn.innerHTML = '<span class="loading"></span>Setting up database...';

            try {
                await apiCall('/setup-database', { method: 'POST' });
                showAlert('setup', 'Database tables created successfully! You can now start adding companies.', 'success');
                updateConnectionStatus(true);
                loadStats();
            } catch (error) {
                showAlert('setup', `Setup failed: ${error.message}`, 'error');
                updateConnectionStatus(false);
            } finally {
                setupBtn.disabled = false;
                setupBtn.innerHTML = 'Initialize Database Tables';
            }
        }

        async function testConnection() {
            const testBtn = document.getElementById('testBtn');
            const dbStatus = document.getElementById('dbStatus');
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="loading"></span>Testing...';
            dbStatus.innerHTML = 'Testing connection...';

            try {
                await apiCall('/companies');
                dbStatus.innerHTML = '✅ Database connection successful!';
                updateConnectionStatus(true);
                loadStats();
            } catch (error) {
                dbStatus.innerHTML = `❌ Connection failed: ${error.message}`;
                updateConnectionStatus(false);
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = 'Test Connection';
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusText.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        async function loadStats() {
            try {
                const [companiesData, productsData, monitoringData] = await Promise.all([
                    apiCall('/companies').catch(() => []),
                    apiCall('/products').catch(() => []),
                    apiCall('/monitoring-configs').catch(() => [])
                ]);

                const newProductsCount = productsData.filter(p => p.is_new_product).length;

                document.getElementById('companiesCount').textContent = companiesData.length || 0;
                document.getElementById('productsCount').textContent = productsData.length || 0;
                document.getElementById('newProductsCount').textContent = newProductsCount || 0;
                document.getElementById('monitoringConfigsCount').textContent = monitoringData.length || 0;

                document.getElementById('statsGrid').style.display = 'grid';
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Company management functions
        async function addCompany() {
            const name = document.getElementById('companyName').value.trim();
            const url = document.getElementById('companyUrl').value.trim();
            const domain = document.getElementById('companyDomain').value.trim();
            const industry = document.getElementById('companyIndustry').value.trim();
            const description = document.getElementById('companyDescription').value.trim();
            
            if (!name) {
                showAlert('companies', 'Company name is required', 'error');
                return;
            }

            try {
                // Add the company first
                const companyResult = await apiCall('/companies', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        name, 
                        url: url || null,
                        domain: domain || null,
                        industry: industry || null,
                        description: description || null
                    })
                });

                // Create default monitoring configuration for the new company
                const defaultMonitoringConfig = {
                    company_id: companyResult.id,
                    days_back: 7,
                    max_products: 50,
                    check_frequency: 'weekly',
                    is_enabled: true
                };

                try {
                    await apiCall('/monitoring-configs', {
                        method: 'POST',
                        body: JSON.stringify(defaultMonitoringConfig)
                    });
                } catch (configError) {
                    console.warn('Failed to create default monitoring config:', configError);
                    // Don't fail the company creation if monitoring config fails
                }
                
                // Clear form
                document.getElementById('companyName').value = '';
                document.getElementById('companyUrl').value = '';
                document.getElementById('companyDomain').value = '';
                document.getElementById('companyIndustry').value = '';
                document.getElementById('companyDescription').value = '';
                
                showAlert('companies', `Company "${name}" added successfully with default monitoring configuration!`, 'success');
                loadCompanies();
                loadStats();
            } catch (error) {
                showAlert('companies', `Failed to add company: ${error.message}`, 'error');
            }
        }

        async function bulkAddCompanies() {
            const bulkInput = document.getElementById('companyBulkInput').value.trim();
            
            if (!bulkInput) {
                showAlert('companies', 'Please enter company names to add', 'error');
                return;
            }

            // Parse input (handle both comma-separated and line-separated)
            let companyNames = [];
            if (bulkInput.includes(',')) {
                companyNames = bulkInput.split(',').map(name => name.trim()).filter(name => name);
            } else {
                companyNames = bulkInput.split('\n').map(name => name.trim()).filter(name => name);
            }

            const companiesToAdd = companyNames.map(name => ({ 
                name, 
                url: null, 
                domain: null, 
                industry: null, 
                description: null 
            }));

            try {
                const result = await apiCall('/companies/bulk', {
                    method: 'POST',
                    body: JSON.stringify({ companies: companiesToAdd })
                });

                // Create default monitoring configurations for all new companies
                if (result.companies && result.companies.length > 0) {
                    const monitoringConfigs = result.companies.map(company => ({
                        company_id: company.id,
                        days_back: 7,
                        max_products: 50,
                        check_frequency: 'weekly',
                        is_enabled: true
                    }));

                    try {
                        // Create monitoring configs in bulk
                        for (const config of monitoringConfigs) {
                            await apiCall('/monitoring-configs', {
                                method: 'POST',
                                body: JSON.stringify(config)
                            });
                        }
                    } catch (configError) {
                        console.warn('Some monitoring configs failed to create:', configError);
                        // Don't fail the bulk creation if some monitoring configs fail
                    }
                }

                document.getElementById('companyBulkInput').value = '';
                showAlert('companies', `${result.count} companies added successfully with default monitoring configurations!`, 'success');
                loadCompanies();
                loadStats();
            } catch (error) {
                showAlert('companies', `Failed to add companies: ${error.message}`, 'error');
            }
        }

        async function loadCompanies() {
            const tbody = document.getElementById('companiesTableBody');
            tbody.innerHTML = '<tr><td colspan="9">Loading...</td></tr>';
            
            try {
                companies = await apiCall('/companies');
                
                tbody.innerHTML = '';
                
                if (companies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9">No companies found. Add some companies above.</td></tr>';
                    return;
                }
                
                companies.forEach(company => {
                    const row = tbody.insertRow();
                    const createdDate = new Date(company.created_at).toLocaleDateString();
                    row.innerHTML = `
                        <td>${company.id}</td>
                        <td>${company.name}</td>
                        <td>${company.url ? `<a href="${company.url}" target="_blank">${company.url}</a>` : 'N/A'}</td>
                        <td>${company.domain || 'N/A'}</td>
                        <td>${company.industry || 'N/A'}</td>
                        <td title="${company.description || ''}">${company.description ? (company.description.length > 50 ? company.description.substring(0, 50) + '...' : company.description) : 'N/A'}</td>
                        <td>${company.is_active ? '✅' : '❌'}</td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-primary" onclick="toggleCompanyStatus(${company.id}, ${!company.is_active})" style="margin-bottom: 5px;">
                                ${company.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteCompany(${company.id})">Delete</button>
                        </td>
                    `;
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="9">Error loading companies: ${error.message}</td></tr>`;
                showAlert('companies', `Failed to load companies: ${error.message}`, 'error');
            }
        }

        async function toggleCompanyStatus(id, newStatus) {
            try {
                await apiCall(`/companies/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                showAlert('companies', `Company ${newStatus ? 'activated' : 'deactivated'} successfully!`, 'success');
                loadCompanies();
            } catch (error) {
                showAlert('companies', `Failed to update company status: ${error.message}`, 'error');
            }
        }

        async function deleteCompany(id) {
            if (!confirm('Are you sure you want to delete this company? This will also delete all associated products and monitoring configs.')) {
                return;
            }

            try {
                await apiCall(`/companies/${id}`, { method: 'DELETE' });
                showAlert('companies', 'Company deleted successfully!', 'success');
                loadCompanies();
                loadStats();
            } catch (error) {
                showAlert('companies', `Failed to delete company: ${error.message}`, 'error');
            }
        }

        async function loadCompaniesForSelect(selectId) {
            try {
                if (companies.length === 0) {
                    companies = await apiCall('/companies');
                }
                
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select a company...</option>';
                
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load companies for select:', error);
            }
        }

        // Product management functions
        async function addProduct() {
            const companyId = document.getElementById('productCompany').value;
            const shopifyProductId = document.getElementById('productShopifyId').value.trim();
            const title = document.getElementById('productTitle').value.trim();
            const handle = document.getElementById('productHandle').value.trim();
            const productType = document.getElementById('productType').value.trim();
            const vendor = document.getElementById('productVendor').value.trim();
            const price = document.getElementById('productPrice').value.trim();
            const daysOld = document.getElementById('productDaysOld').value.trim();
            const createdAtShopify = document.getElementById('productCreatedAtShopify').value;
            const productUrl = document.getElementById('productUrl').value.trim();
            const imageUrl = document.getElementById('productImageUrl').value.trim();
            const tags = document.getElementById('productTags').value.trim();
            const isNewProduct = document.getElementById('productIsNew').checked;
            
            if (!title || !companyId) {
                showAlert('products', 'Product title and company are required', 'error');
                return;
            }

            const productData = {
                company_id: companyId,
                title: title,
                shopify_product_id: shopifyProductId ? parseInt(shopifyProductId) : null,
                handle: handle || null,
                product_type: productType || null,
                vendor: vendor || null,
                price: price ? parseFloat(price) : null,
                days_old_when_found: daysOld ? parseInt(daysOld) : null,
                created_at_shopify: createdAtShopify || null,
                product_url: productUrl || null,
                main_image_url: imageUrl || null,
                tags: tags || null,
                is_new_product: isNewProduct
            };

            try {
                await apiCall('/products', {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });
                
                // Clear form
                clearProductForm();
                
                showAlert('products', `Product "${title}" added successfully!`, 'success');
                loadProducts();
                loadStats();
            } catch (error) {
                showAlert('products', `Failed to add product: ${error.message}`, 'error');
            }
        }

        function clearProductForm() {
            document.getElementById('productCompany').value = '';
            document.getElementById('productShopifyId').value = '';
            document.getElementById('productTitle').value = '';
            document.getElementById('productHandle').value = '';
            document.getElementById('productType').value = '';
            document.getElementById('productVendor').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDaysOld').value = '';
            document.getElementById('productCreatedAtShopify').value = '';
            document.getElementById('productUrl').value = '';
            document.getElementById('productImageUrl').value = '';
            document.getElementById('productTags').value = '';
            document.getElementById('productIsNew').checked = true;
        }

        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '<tr><td colspan="14">Loading...</td></tr>';
            
            try {
                products = await apiCall('/products');
                
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="14">No products found. Add some products above.</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = tbody.insertRow();
                    const firstSeen = product.first_seen ? new Date(product.first_seen).toLocaleDateString() : 'N/A';
                    const lastSeen = product.last_seen ? new Date(product.last_seen).toLocaleDateString() : 'N/A';
                    const price = product.price ? `${parseFloat(product.price).toFixed(2)}` : 'N/A';
                    const imageCell = product.main_image_url ? 
                        `<img src="${product.main_image_url}" class="product-image" alt="Product" onclick="window.open('${product.main_image_url}', '_blank')">` : 
                        'N/A';
                    const productLink = product.product_url ? 
                        `<a href="${product.product_url}" target="_blank" title="${product.title}">${product.title.length > 30 ? product.title.substring(0, 30) + '...' : product.title}</a>` :
                        (product.title.length > 30 ? product.title.substring(0, 30) + '...' : product.title);
                    
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.company_name || 'N/A'}</td>
                        <td>${product.shopify_product_id || 'N/A'}</td>
                        <td title="${product.title}">${productLink}</td>
                        <td>${product.handle || 'N/A'}</td>
                        <td>${product.product_type || 'N/A'}</td>
                        <td>${product.vendor || 'N/A'}</td>
                        <td>${price}</td>
                        <td>${product.days_old_when_found || 'N/A'}</td>
                        <td>${imageCell}</td>
                        <td>${product.is_new_product ? '🆕' : '📦'}</td>
                        <td>${firstSeen}</td>
                        <td>${lastSeen}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewProductDetails(${product.id})" title="View Details">👁️</button>
                            <button class="btn btn-danger" onclick="deleteProduct(${product.id})" title="Delete">🗑️</button>
                        </td>
                    `;
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="14">Error loading products: ${error.message}</td></tr>`;
                showAlert('products', `Failed to load products: ${error.message}`, 'error');
            }
        }

        function viewProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const details = `
Product Details:
- ID: ${product.id}
- Company: ${product.company_name || 'N/A'}
- Shopify ID: ${product.shopify_product_id || 'N/A'}
- Title: ${product.title}
- Handle: ${product.handle || 'N/A'}
- Type: ${product.product_type || 'N/A'}
- Vendor: ${product.vendor || 'N/A'}
- Price: ${product.price ? ' + parseFloat(product.price).toFixed(2) : 'N/A'}
- Days Old: ${product.days_old_when_found || 'N/A'}
- Created at Shopify: ${product.created_at_shopify ? new Date(product.created_at_shopify).toLocaleString() : 'N/A'}
- Product URL: ${product.product_url || 'N/A'}
- Image URL: ${product.main_image_url || 'N/A'}
- Tags: ${product.tags || 'N/A'}
- Is New Product: ${product.is_new_product ? 'Yes' : 'No'}
- First Seen: ${product.first_seen ? new Date(product.first_seen).toLocaleString() : 'N/A'}
- Last Seen: ${product.last_seen ? new Date(product.last_seen).toLocaleString() : 'N/A'}
            `;
            
            alert(details);
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                await apiCall(`/products/${id}`, { method: 'DELETE' });
                showAlert('products', 'Product deleted successfully!', 'success');
                loadProducts();
                loadStats();
            } catch (error) {
                showAlert('products', `Failed to delete product: ${error.message}`, 'error');
            }
        }

        // Monitoring configuration functions
        async function saveMonitoringConfig() {
            const companyId = document.getElementById('monitoringCompany').value;
            
            if (!companyId) {
                showAlert('monitoring', 'Please select a company', 'error');
                return;
            }

            const config = {
                company_id: companyId,
                days_back: parseInt(document.getElementById('daysBack').value) || 7,
                max_products: parseInt(document.getElementById('maxProducts').value) || 50,
                check_frequency: document.getElementById('checkFrequency').value,
                is_enabled: document.getElementById('isEnabled').checked
            };

            try {
                // Use POST for both create and update - let the backend handle upsert logic
                await apiCall('/monitoring-configs', {
                    method: 'POST',
                    body: JSON.stringify(config)
                });

                const company = companies.find(c => c.id == companyId);
                const existingConfig = monitoringConfigs.find(c => c.company_id == companyId);
                const action = existingConfig ? 'updated' : 'created';
                
                showAlert('monitoring', `Monitoring configuration ${action} for ${company?.name || 'selected company'}!`, 'success');
                loadMonitoringConfigs();
                clearMonitoringForm();
                loadStats();
            } catch (error) {
                console.error('Monitoring config save error:', error);
                showAlert('monitoring', `Failed to save monitoring config: ${error.message}`, 'error');
            }
        }

        async function loadMonitoringConfigs() {
            const tbody = document.getElementById('monitoringTableBody');
            tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
            
            try {
                monitoringConfigs = await apiCall('/monitoring-configs');
                
                tbody.innerHTML = '';
                
                if (monitoringConfigs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No monitoring configurations found.</td></tr>';
                    return;
                }
                
                monitoringConfigs.forEach(config => {
                    const row = tbody.insertRow();
                    const lastMonitored = config.last_monitored ? 
                        new Date(config.last_monitored).toLocaleDateString() : 'Never';
                    
                    row.innerHTML = `
                        <td>${config.company_name || 'N/A'}</td>
                        <td>${config.days_back || 7}</td>
                        <td>${config.max_products || 50}</td>
                        <td>${config.check_frequency || 'weekly'}</td>
                        <td>${config.is_enabled ? '✅ Enabled' : '❌ Disabled'}</td>
                        <td>${lastMonitored}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editMonitoringConfig(${config.company_id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMonitoringConfig(${config.company_id})">Delete</button>
                        </td>
                    `;
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7">Error loading configs: ${error.message}</td></tr>`;
                showAlert('monitoring', `Failed to load monitoring configs: ${error.message}`, 'error');
            }
        }

        function editMonitoringConfig(companyId) {
            const config = monitoringConfigs.find(c => c.company_id == companyId);
            if (!config) return;

            // Populate the form with existing values
            document.getElementById('monitoringCompany').value = companyId;
            document.getElementById('daysBack').value = config.days_back || 7;
            document.getElementById('maxProducts').value = config.max_products || 50;
            document.getElementById('checkFrequency').value = config.check_frequency || 'weekly';
            document.getElementById('isEnabled').checked = config.is_enabled !== false;

            // Update the save button text to indicate we're editing
            const saveBtn = document.querySelector('button[onclick="saveMonitoringConfig()"]');
            if (saveBtn) {
                saveBtn.textContent = 'Update Configuration';
                saveBtn.classList.add('btn-warning');
                saveBtn.classList.remove('btn-primary');
            }

            // Scroll to the form
            document.getElementById('monitoringCompany').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Show alert to indicate editing mode
            showAlert('monitoring', `Editing configuration for ${config.company_name}. Make your changes and click "Update Configuration".`, 'success');
        }

        async function deleteMonitoringConfig(companyId) {
            if (!confirm('Are you sure you want to delete this monitoring configuration?')) {
                return;
            }

            try {
                await apiCall(`/monitoring-configs/${companyId}`, { method: 'DELETE' });
                showAlert('monitoring', 'Monitoring configuration deleted successfully!', 'success');
                loadMonitoringConfigs();
                loadStats();
            } catch (error) {
                showAlert('monitoring', `Failed to delete monitoring config: ${error.message}`, 'error');
            }
        }

        function clearMonitoringForm() {
            document.getElementById('monitoringCompany').value = '';
            document.getElementById('daysBack').value = '7';
            document.getElementById('maxProducts').value = '50';
            document.getElementById('checkFrequency').value = 'weekly';
            document.getElementById('isEnabled').checked = true;

            // Reset the save button to default state
            const saveBtn = document.querySelector('button[onclick="saveMonitoringConfig()"]');
            if (saveBtn) {
                saveBtn.textContent = 'Save Configuration';
                saveBtn.classList.add('btn-primary');
                saveBtn.classList.remove('btn-warning');
            }
        }

        function copyConfigTemplate() {
            const template = document.getElementById('configTemplate').textContent;
            navigator.clipboard.writeText(template).then(() => {
                showAlert('monitoring', 'Configuration template copied to clipboard!', 'success');
            });
        }

        function applyConfigTemplate() {
            navigator.clipboard.readText().then(text => {
                try {
                    const config = JSON.parse(text);
                    
                    if (config.daysBack) document.getElementById('daysBack').value = config.daysBack;
                    if (config.maxProducts) document.getElementById('maxProducts').value = config.maxProducts;
                    if (config.checkFrequency) document.getElementById('checkFrequency').value = config.checkFrequency;
                    if (config.isEnabled !== undefined) document.getElementById('isEnabled').checked = config.isEnabled;
                    
                    showAlert('monitoring', 'Configuration template applied successfully!', 'success');
                } catch (error) {
                    showAlert('monitoring', 'Invalid JSON format in clipboard', 'error');
                }
            }).catch(() => {
                showAlert('monitoring', 'Failed to read from clipboard', 'error');
            });
        }

        // Utility functions
        function showAlert(section, message, type) {
            const alertDiv = document.getElementById(section + 'Alert');
            alertDiv.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
